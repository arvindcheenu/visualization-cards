<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ViBBS – Visualization Building Blocks and Scenarios</title>
    <!-- PWA Meta Tags -->
    <meta name="description" content="Explore and organize different visualization techniques and design patterns with interactive cards">
    <meta name="theme-color" content="#1f2937">
    <meta name="background-color" content="#ffffff">
    <link rel="manifest" href="manifest.json">
    <!-- Apple Touch Icon -->
    <link rel="apple-touch-icon" href="icons/icon-256.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="ViBBS – Visualization Building Blocks and Scenarios">
    <!-- Microsoft Tiles -->
    <meta name="msapplication-TileImage" content="icons/icon-256.png">
    <meta name="msapplication-TileColor" content="#1f2937">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class'
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="font-sans bg-white dark:bg-gray-900 text-black dark:text-white overflow-hidden transition-colors duration-300">
    <!-- PWA Install Banner -->
    <div id="installBanner" class="fixed top-0 left-0 right-0 bg-blue-600 text-white p-3 flex items-center justify-between z-50 transform -translate-y-full transition-transform duration-300">
        <div class="flex items-center gap-3">
            <i class="fas fa-download"></i>
            <span class="text-sm font-medium">Install ViBBS – Visualization Building Blocks and Scenarios for offline access</span>
        </div>
        <div class="flex gap-2">
            <button id="installButton" class="bg-white text-blue-600 px-3 py-1 rounded text-sm font-medium hover:bg-gray-100 transition-colors">
                Install
            </button>
            <button id="dismissInstall" class="text-white hover:text-gray-200 transition-colors">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
    <!-- Header -->
    <div class="text-center border-b border-gray-300 dark:border-gray-600">
        <div class="flex items-center justify-between pl-4 pr-4 py-3 bg-gray-50 dark:bg-gray-800">
            <div class="flex flex-col text-left gap-0">
                <h1 class="text-xl font-semibold">ViBBS</h1>
                <h4 class="text-sm text-gray-600 dark:text-gray-400">Visualization Building Blocks and Scenarios</h4>
            </div>
            <div class="flex gap-2">
                <!-- PWA Status Indicator -->
                <div id="pwaStatus" class="bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 w-8 h-8 rounded-full flex items-center justify-center transition-colors duration-200" title="PWA Status">
                    <i class="fas fa-wifi text-sm" id="statusIcon"></i>
                </div>
                <button class="bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 w-8 h-8 rounded-full flex items-center justify-center transition-colors duration-200" 
                        onclick="toggleDarkMode()" id="darkModeToggle">
                    <i class="fas fa-moon text-sm" id="darkModeIcon"></i>
                </button>
                <button class="bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 w-8 h-8 rounded-full flex items-center justify-center transition-colors duration-200" 
                        onclick="openInfoModal()">
                    <i class="fas fa-info text-sm"></i>
                </button>
            </div>
        </div>
    </div>
    <!-- Main Container -->
    <div class="h-screen flex flex-col" style="height: calc(100vh - 120px);">
        <div class="flex-1 overflow-y-scroll">
            <div class="h-full flex flex-row" id="decksContainer">
                <!-- Decks will be generated by JavaScript -->
            </div>
        </div>
    </div>
    <!-- Pinned Cards Drawer -->
    <div class="fixed bottom-3 left-0 right-0 bg-white dark:bg-gray-800 border-t border-gray-300 dark:border-gray-600 z-50 transform transition-transform duration-300" 
         id="drawer" style="transform: translateY(calc(100% - 48px)); box-shadow: 0 -4px 6px -1px rgba(0,0,0,0.1);">
        <div class="flex justify-between items-center border-b border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 cursor-pointer" 
             onclick="toggleDrawer()">
            <h2 class="font-semibold p-4">
                Pinned Cards
                <span class="ml-2 bg-gray-600 dark:bg-gray-500 text-white px-3 py-1 text-xs rounded-full" id="pinnedCount">0</span>
            </h2>
            <button class="text-lg p-4 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600">
                <i class="fas fa-chevron-up"></i>
            </button>
        </div>
        <div class="h-[520px] flex flex-col">
            <div class="flex gap-2 flex-nowrap p-4 w-full overflow-x-scroll overflow-y-hidden" id="filterPills">
                <!-- Filter pills will be generated by JavaScript -->
            </div>
            <div class="flex-1 overflow-hidden">
                <div class="flex gap-4 h-full overflow-x-auto" id="pinnedCards">
                    <div class="flex items-center justify-center h-48 text-gray-500 dark:text-gray-400 text-center min-w-full">
                        No cards pinned yet. Pin some cards to see them here!
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Info Modal -->
    <div class="fixed inset-0 bg-black bg-opacity-50 dark:bg-black dark:bg-opacity-70 z-50 flex items-center justify-center hidden" id="infoModal" onclick="closeInfoModal()">
        <div class="bg-white dark:bg-gray-800 rounded-lg max-w-2xl max-h-[80vh] overflow-y-auto m-4 shadow-xl" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center border-b border-gray-200 dark:border-gray-600 p-6 py-3 bg-gray-50 dark:bg-gray-700">
                <h2 class="text-xl font-semibold">About ViBBS – Visualization Building Blocks and Scenarios</h2>
                <button class="text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 w-8 h-8 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center justify-center" 
                        onclick="closeInfoModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6 space-y-4">
                <p class="text-gray-700 dark:text-gray-300 leading-relaxed">
                    The <b>ViBBS – Visualization Building Blocks and Scenarios</b> tool helps you explore and organize different visualization techniques and design patterns. 
                    Each card represents a specific approach or method that can be applied to data visualization projects.
                    Cards courtesy of <a href="https://www.igd.fraunhofer.de/de/institut/mitarbeitende/thorsten-may.html" class="text-blue-600 dark:text-blue-400 hover:underline" target="_blank">Thorsten May</a> from Fraunhofer IGD, <a href="https://lcibulski.github.io/" class="text-blue-600 dark:text-blue-400 hover:underline" target="_blank">Lena Cibulski</a> from the University of Rostock, <a href="https://www.au.dk/en/petermus@au.dk" class="text-blue-600 dark:text-blue-400 hover:underline" target="_blank">Peter Musaeus</a> and <a href="https://cs.au.dk/~hjschulz/" class="text-blue-600 dark:text-blue-400 hover:underline" target="_blank">Hans-Jörg Schulz</a> from Aarhus University. Developed by <a href="https://arvindchee.nu/" class="text-blue-600 dark:text-blue-400 hover:underline" target="_blank">Arvind Srinivasan</a> as a personal project to make these digital.
                </p>
                <div class="space-y-3">
                    <h3 class="font-semibold text-lg">Card Categories</h3>
                    <div class="space-y-3">
                        <div class="flex items-start gap-3">
                            <div class="w-4 h-4 bg-sky-600 rounded-sm mt-1 flex-shrink-0"></div>
                            <div>
                                <h4 class="font-medium">Visualization</h4>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Specific chart types and visualization formats including bar charts, scatterplots, treemaps, and network diagrams.</p>
                            </div>
                        </div>
                        <div class="flex items-start gap-3">
                            <div class="w-4 h-4 bg-blue-600 rounded-sm mt-1 flex-shrink-0"></div>
                            <div>
                                <h4 class="font-medium">Mapping</h4>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Visual encoding methods that map data to visual properties like color, size, shape, and position.</p>
                            </div>
                        </div>
                        <div class="flex items-start gap-3">
                            <div class="w-4 h-4 bg-purple-600 rounded-sm mt-1 flex-shrink-0"></div>
                            <div>
                                <h4 class="font-medium">Layout</h4>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Spatial arrangement and composition techniques including small multiples, nesting, and juxtaposition patterns.</p>
                            </div>
                        </div>
                        <div class="flex items-start gap-3">
                            <div class="w-4 h-4 bg-green-600 rounded-sm mt-1 flex-shrink-0"></div>
                            <div>
                                <h4 class="font-medium">Interaction</h4>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Interactive techniques like brushing, filtering, zooming, and tooltips that allow users to explore data dynamically.</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="space-y-3">
                    <h3 class="font-semibold text-lg">How to Use</h3>
                    <ul class="space-y-2 text-sm text-gray-700 dark:text-gray-300">
                        <li class="flex items-start gap-2">
                            <i class="fas fa-thumbtack text-xs mt-1 text-gray-500 dark:text-gray-400"></i>
                            <span><strong>Pin cards</strong> by clicking on them or using the pin button to save them to your collection</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <i class="fas fa-eye-slash text-xs mt-1 text-gray-500 dark:text-gray-400"></i>
                            <span><strong>Hide pinned cards</strong> in each category to focus on unpinned options</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <i class="fas fa-filter text-xs mt-1 text-gray-500 dark:text-gray-400"></i>
                            <span><strong>Filter pinned cards</strong> by category in the bottom drawer</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <i class="fas fa-chevron-up text-xs mt-1 text-gray-500 dark:text-gray-400"></i>
                            <span><strong>Open the drawer</strong> at the bottom to view and manage your pinned cards</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <i class="fas fa-moon text-xs mt-1 text-gray-500 dark:text-gray-400"></i>
                            <span><strong>Toggle dark mode</strong> using the moon/sun button in the header</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <i class="fas fa-download text-xs mt-1 text-gray-500 dark:text-gray-400"></i>
                            <span><strong>Install as PWA</strong> for offline access and app-like experience</span>
                        </li>
                    </ul>
                </div>
                <div class="bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
                    <p class="text-sm text-blue-800 dark:text-blue-200">
                        <i class="fas fa-lightbulb mr-2"></i>
                        <strong>Tip:</strong> Use this tool during the design process to explore different visualization approaches and build a collection of techniques relevant to your project.
                    </p>
                </div>
            </div>
        </div>
    </div>
    <script>
        // PWA variables
        let deferredPrompt;
        let isInstalled = false;
        // Dark mode state
        let darkMode = false;
        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then((registration) => {
                        console.log('ServiceWorker registration successful');
                        updatePWAStatus('online');
                    })
                    .catch((err) => {
                        console.log('ServiceWorker registration failed: ', err);
                        updatePWAStatus('offline');
                    });
            });
        }
        // PWA Install Handler
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            showInstallBanner();
        });
        // Check if app is installed
        window.addEventListener('appinstalled', () => {
            isInstalled = true;
            hideInstallBanner();
            updatePWAStatus('installed');
        });
        // Show install banner
        function showInstallBanner() {
            if (!isInstalled) {
                const banner = document.getElementById('installBanner');
                banner.style.transform = 'translateY(0)';
            }
        }
        // Hide install banner
        function hideInstallBanner() {
            const banner = document.getElementById('installBanner');
            banner.style.transform = 'translateY(-100%)';
        }
        // Install button handler
        document.getElementById('installButton').addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    hideInstallBanner();
                }
                deferredPrompt = null;
            }
        });
        // Dismiss install banner
        document.getElementById('dismissInstall').addEventListener('click', () => {
            hideInstallBanner();
        });
        // Update PWA status indicator
        function updatePWAStatus(status) {
            const statusIcon = document.getElementById('statusIcon');
            const pwaStatus = document.getElementById('pwaStatus');
            switch(status) {
                case 'online':
                    statusIcon.className = 'fas fa-wifi text-sm';
                    pwaStatus.title = 'Online';
                    pwaStatus.className = 'bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300 w-8 h-8 rounded-full flex items-center justify-center transition-colors duration-200';
                    break;
                case 'offline':
                    statusIcon.className = 'fas fa-wifi-slash text-sm';
                    pwaStatus.title = 'Offline';
                    pwaStatus.className = 'bg-orange-100 dark:bg-orange-900 text-orange-700 dark:text-orange-300 w-8 h-8 rounded-full flex items-center justify-center transition-colors duration-200';
                    break;
                case 'installed':
                    statusIcon.className = 'fas fa-mobile-alt text-sm';
                    pwaStatus.title = 'Installed PWA';
                    pwaStatus.className = 'bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 w-8 h-8 rounded-full flex items-center justify-center transition-colors duration-200';
                    break;
            }
        }
        // Monitor online/offline status
        window.addEventListener('online', () => updatePWAStatus('online'));
        window.addEventListener('offline', () => updatePWAStatus('offline'));
        // Initialize dark mode based on system preference
        function initDarkMode() {
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const savedDarkMode = localStorage.getItem('darkMode');
            darkMode = savedDarkMode ? JSON.parse(savedDarkMode) : systemPrefersDark;
            applyDarkMode();
        }
        // Apply dark mode
        function applyDarkMode() {
            const html = document.documentElement;
            const icon = document.getElementById('darkModeIcon');
            if (darkMode) {
                html.classList.add('dark');
                icon.className = 'fas fa-sun text-sm';
            } else {
                html.classList.remove('dark');
                icon.className = 'fas fa-moon text-sm';
            }
            localStorage.setItem('darkMode', JSON.stringify(darkMode));
        }
        // Toggle dark mode
        function toggleDarkMode() {
            darkMode = !darkMode;
            applyDarkMode();
        }
        // Card data structure based on actual files
        const cardData = {

            visualization: [
                'area-chart', 'bar-chart', 'boxplot', 'bubble-chart', 'chloropleth-map',
                'dendrogram', 'dot-plot', 'heatmap', 'histogram', 'horizon-plot',
                'icicle-plot', 'line-chart', 'lollipop', 'matrix', 'node-link-diagram',
                'normalized-stacked-bar-chart', 'pie-chart', 'scatterplot', 'stacked-area-chart',
                'stacked-bar-chart', 'starplot', 'sunburst', 'table', 'treemap', 'violin-plot'
            ],
            mapping: [
                'color-categorical', 'color-diverging', 'color-diverging-discrete', 'color-sequential',
                'color-sequential-discrete', 'label', 'length', 'orientation',
                'outline', 'redundant-mapping', 'shape', 'size', 'texture', 'variable-mapping'
            ],
            layout: [
                'attentive-arrangement', 'captivating-caption', 'juxtaposition', 'juxtaposition-similar',
                'legendary-legends', 'nested-axis', 'nesting', 'nice-numbers',
                'overloading', 'small-multiples', 'sparklines', 'superimposition', 'superimposition-similar'
            ],
            interaction: [
                'brushing', 'brushing-and-linking', 'details-on-demand', 'faceted-search',
                'filtering', 'fish-eye-zoom', 'magic-lens', 'overview-and-detail',
                'search', 'semantic-zoom', 'sorting', 'tooltip', 'zoom-and-pan'
            ]
        };
        const decks = [
            { 
                title: "Visualization", 
                key: "visualization", 
                cards: cardData.visualization, 
                borderColor: "border-sky-800",
                bgColor: "bg-sky-50 dark:bg-sky-900/20",
                headerBgColor: "bg-sky-800 text-white dark:bg-sky-800",
                activePillColor: "bg-sky-600 dark:bg-sky-500",
                activePillHover: "hover:bg-sky-700 dark:hover:bg-sky-600"
            },
            { 
                title: "Mapping", 
                key: "mapping", 
                cards: cardData.mapping, 
                borderColor: "border-blue-800",
                bgColor: "bg-blue-50 dark:bg-blue-900/20",
                headerBgColor: "bg-blue-800 text-white dark:bg-blue-800",
                activePillColor: "bg-blue-600 dark:bg-blue-500",
                activePillHover: "hover:bg-blue-700 dark:hover:bg-blue-600"
            },
            { 
                title: "Layout", 
                key: "layout", 
                cards: cardData.layout, 
                borderColor: "border-purple-800",
                bgColor: "bg-purple-50 dark:bg-purple-900/20",
                headerBgColor: "bg-purple-800 text-white dark:bg-purple-800",
                activePillColor: "bg-purple-600 dark:bg-purple-500",
                activePillHover: "hover:bg-purple-700 dark:hover:bg-purple-600"
            },
            { 
                title: "Interaction", 
                key: "interaction", 
                cards: cardData.interaction, 
                borderColor: "border-green-800",
                bgColor: "bg-green-50 dark:bg-green-900/20",
                headerBgColor: "bg-green-800 text-white dark:bg-green-800",
                activePillColor: "bg-green-600 dark:bg-green-500",
                activePillHover: "hover:bg-green-700 dark:hover:bg-green-600"
            }
        ];
        let pinnedCards = [];
        let hidePinnedStates = [false, false, false, false];
        let activeFilter = 'all';
        // Load data from localStorage
        function loadData() {
            const savedPinnedCards = localStorage.getItem('pinnedCards');
            const savedHidePinnedStates = localStorage.getItem('hidePinnedStates');
            const savedActiveFilter = localStorage.getItem('activeFilter');
            if (savedPinnedCards) {
                pinnedCards = JSON.parse(savedPinnedCards);
            }
            if (savedHidePinnedStates) {
                hidePinnedStates = JSON.parse(savedHidePinnedStates);
            }
            if (savedActiveFilter) {
                activeFilter = savedActiveFilter;
            }
        }
        // Save data to localStorage
        function saveData() {
            localStorage.setItem('pinnedCards', JSON.stringify(pinnedCards));
            localStorage.setItem('hidePinnedStates', JSON.stringify(hidePinnedStates));
            localStorage.setItem('activeFilter', activeFilter);
        }
        // Initialize the application
        function init() {
            initDarkMode();
            loadData();
            renderDecks();
            updatePinnedCount();
            updateFilterPills();
            updatePinnedCardsDisplay();
            // Check if running as PWA
            if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone) {
                isInstalled = true;
                updatePWAStatus('installed');
            }
        }
        // Render all decks
        function renderDecks() {
            const container = document.getElementById('decksContainer');
            container.innerHTML = '';
            decks.forEach((deck, deckIndex) => {
                const deckElement = createDeckElement(deck, deckIndex);
                container.appendChild(deckElement);
            });
        }
        // Create a deck element
        function createDeckElement(deck, deckIndex) {
            const deckDiv = document.createElement('div');
            deckDiv.className = `flex-1 border border-[0.5px] ${deck.borderColor} flex flex-col min-h-0 ${deck.bgColor}`;
            deckDiv.id = `deck-${deckIndex}`;
            const visibleCardCount = getVisibleCardCount(deckIndex);
            deckDiv.innerHTML = `
                <div class="flex justify-between items-center border-b ${deck.borderColor} ${deck.headerBgColor} flex-shrink-0">
                    <h3 class="font-semibold p-4">
                        ${deck.title}
                        <span class="ml-2 ${deck.activePillColor} text-white px-3 py-1 text-xs rounded-full" id="count-${deckIndex}">${visibleCardCount}</span>
                    </h3>
                    <button class="bg-white dark:bg-gray-700 text-black dark:text-white border border-gray-600 dark:border-gray-500 hover:bg-gray-50 dark:hover:bg-gray-600 text-sm flex items-center gap-2 mr-2 px-4 py-2 rounded-lg transition-colors duration-200" 
                            id="hideButton-${deckIndex}"
                            onclick="toggleHidePinned(${deckIndex})">
                        <i class="fas ${hidePinnedStates[deckIndex] ? 'fa-eye' : 'fa-eye-slash'}" id="hideIcon-${deckIndex}"></i>
                        <span id="hideText-${deckIndex}">${hidePinnedStates[deckIndex] ? 'Show Pinned' : 'Hide Pinned'}</span>
                    </button>
                </div>
                <div class="flex-1 overflow-y-auto min-h-0">
                    <div class="flex flex-col gap-4 p-4 items-center" id="cardsContainer-${deckIndex}">
                        ${generateCards(deck, deckIndex)}
                    </div>
                </div>
            `;
            return deckDiv;
        }
        // Get count of visible cards in a deck
        function getVisibleCardCount(deckIndex) {
            let count = 0;
            for (let i = 0; i < decks[deckIndex].cards.length; i++) {
                const cardId = `${deckIndex}-${i}`;
                const isPinned = pinnedCards.some(card => card.id === cardId);
                const shouldHide = hidePinnedStates[deckIndex] && isPinned;
                if (!shouldHide) count++;
            }
            return count;
        }
        // Format card name for display
        function formatCardName(cardName) {
            return cardName.split('-').map(word => 
                word.charAt(0).toUpperCase() + word.slice(1)
            ).join(' ');
        }
        // Get border color for card image based on deck and pin status
        function getCardImageBorderColor(deckIndex, isPinned) {
            if (isPinned) {
                return 'border-black dark:border-white';
            }
            return decks[deckIndex].borderColor;
        }
        // Generate cards for a deck
        function generateCards(deck, deckIndex) {
            let cardsHTML = '';
            let hasVisibleCard = false;
            for (let i = 0; i < deck.cards.length; i++) {
                const cardId = `${deckIndex}-${i}`;
                const cardName = deck.cards[i];
                const imagePath = `cards/${deck.key}_${cardName}.png`;
                const displayName = formatCardName(cardName);
                const isPinned = pinnedCards.some(card => card.id === cardId);
                const shouldHide = hidePinnedStates[deckIndex] && isPinned;
                if (!shouldHide) {
                    hasVisibleCard = true;
                    const imageBorderColor = getCardImageBorderColor(deckIndex, isPinned);
                    const shadowClass = isPinned ? 'shadow-lg shadow-gray-400 dark:shadow-gray-600' : '';
                    const bgClass = isPinned ? 'bg-blue-50 dark:bg-blue-900/30' : 'bg-white dark:bg-gray-800';
                    cardsHTML += `
                        <div class="w-[300px] ${bgClass} ${shadowClass} rounded-lg transition-all duration-200 cursor-pointer" 
                             id="card-${cardId}"
                             onclick="togglePin('${cardId}', ${deckIndex}, ${i})">
                            <div class="w-full rounded-lg bg-gray-100 dark:bg-gray-700 ${imageBorderColor} border-4 flex items-center justify-center text-gray-600 dark:text-gray-400 overflow-hidden relative" 
                                 style="aspect-ratio: 10/16;">
                                <img src="${imagePath}" alt="${displayName}" 
                                     class="w-full h-full object-cover"
                                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                <div class="w-full h-full flex items-center justify-center text-gray-400 dark:text-gray-500 text-sm" style="display: none;">
                                    ${displayName}
                                </div>
                                <button class="absolute top-3 right-3 w-8 h-8 rounded-full text-white text-sm flex items-center justify-center ${isPinned ? 'bg-red-600 hover:bg-red-700' : 'bg-black hover:bg-gray-700 dark:bg-gray-600 dark:hover:bg-gray-500'} z-10 transition-colors duration-200" 
                                        onclick="event.stopPropagation(); togglePin('${cardId}', ${deckIndex}, ${i})">
                                    <i class="fas ${isPinned ? 'fa-times' : 'fa-thumbtack'}"></i>
                                </button>
                            </div>
                        </div>
                    `;
                }
            }
            return hasVisibleCard ? cardsHTML : 
                '<div class="w-[300px] bg-white dark:bg-gray-800 rounded-lg"><div class="w-full bg-gray-100 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 border-4 flex items-center justify-center text-gray-600 dark:text-gray-400 p-4 rounded-lg" style="aspect-ratio: 10/16;">All cards are pinned</div></div>';
        }
        // Toggle pin status of a card
        function togglePin(cardId, deckIndex, cardIndex) {
            const existingIndex = pinnedCards.findIndex(card => card.id === cardId);
            if (existingIndex !== -1) {
                pinnedCards.splice(existingIndex, 1);
            } else {
                const deck = decks[deckIndex];
                const cardName = deck.cards[cardIndex];
                pinnedCards.push({
                    id: cardId,
                    deckIndex: deckIndex,
                    cardIndex: cardIndex,
                    title: deck.title,
                    cardName: cardName,
                    displayName: formatCardName(cardName),
                    imagePath: `cards/${deck.key}_${cardName}.png`,
                    cardNumber: cardIndex + 1,
                    totalCards: deck.cards.length
                });
            }
            updateSpecificCard(cardId, deckIndex, cardIndex);
            updateDeckCardCount(deckIndex);
            updateFilterPills();
            updatePinnedCardsDisplay();
            updatePinnedCount();
            saveData();
        }
        // Update only a specific card
        function updateSpecificCard(cardId, deckIndex, cardIndex) {
            const cardElement = document.getElementById(`card-${cardId}`);
            if (!cardElement) return;
            const isPinned = pinnedCards.some(card => card.id === cardId);
            const button = cardElement.querySelector('button');
            const icon = button.querySelector('i');
            const imageContainer = cardElement.querySelector('div > div');
            const imageBorderColor = getCardImageBorderColor(deckIndex, isPinned);
            if (isPinned) {
                cardElement.className = `w-[300px] bg-blue-50 dark:bg-blue-900/30 shadow-lg shadow-gray-400 dark:shadow-gray-600 rounded-lg transition-all duration-200 cursor-pointer`;
                button.className = 'absolute top-3 right-3 w-8 h-8 rounded-full text-white text-sm flex items-center justify-center bg-red-600 hover:bg-red-700 z-10 transition-colors duration-200';
                icon.className = 'fas fa-times';
                imageContainer.className = `w-full rounded-lg bg-gray-100 dark:bg-gray-700 ${imageBorderColor} border-4 flex items-center justify-center text-gray-600 dark:text-gray-400 overflow-hidden relative`;
            } else {
                cardElement.className = `w-[300px] bg-white dark:bg-gray-800 rounded-lg transition-all duration-200 cursor-pointer`;
                button.className = 'absolute top-3 right-3 w-8 h-8 rounded-full text-white text-sm flex items-center justify-center bg-black hover:bg-gray-700 dark:bg-gray-600 dark:hover:bg-gray-500 z-10 transition-colors duration-200';
                icon.className = 'fas fa-thumbtack';
                imageContainer.className = `w-full rounded-lg bg-gray-100 dark:bg-gray-700 ${imageBorderColor} border-4 flex items-center justify-center text-gray-600 dark:text-gray-400 overflow-hidden relative`;
            }
            if (hidePinnedStates[deckIndex] && isPinned) {
                cardElement.style.display = 'none';
            } else {
                cardElement.style.display = 'block';
            }
        }
        // Update deck card count
        function updateDeckCardCount(deckIndex) {
            const countElement = document.getElementById(`count-${deckIndex}`);
            if (countElement) {
                countElement.textContent = getVisibleCardCount(deckIndex);
            }
        }
        // Toggle hide pinned state
        function toggleHidePinned(deckIndex) {
            hidePinnedStates[deckIndex] = !hidePinnedStates[deckIndex];
            // Update the button elements using their specific IDs
            const icon = document.getElementById(`hideIcon-${deckIndex}`);
            const text = document.getElementById(`hideText-${deckIndex}`);
            if (icon && text) {
                icon.className = `fas ${hidePinnedStates[deckIndex] ? 'fa-eye' : 'fa-eye-slash'}`;
                text.textContent = hidePinnedStates[deckIndex] ? 'Show Pinned' : 'Hide Pinned';
            }
            // Update all cards in this deck
            for (let i = 0; i < decks[deckIndex].cards.length; i++) {
                const cardId = `${deckIndex}-${i}`;
                updateSpecificCard(cardId, deckIndex, i);
            }
            updateDeckCardCount(deckIndex);
            saveData();
        }
        // Update filter pills
        function updateFilterPills() {
            const container = document.getElementById('filterPills');
            const deckCounts = decks.map((deck, index) => {
                return pinnedCards.filter(card => card.deckIndex === index).length;
            });
            const totalCount = pinnedCards.length;
            let pillsHTML = `
                <button class="text-sm border border-gray-300 dark:border-gray-600 ${activeFilter === 'all' ? 'bg-blue-600 dark:bg-blue-500 text-white hover:bg-blue-700 dark:hover:bg-blue-600' : 'bg-gray-50 dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600'} px-2 pl-4 py-2 rounded-full transition-colors duration-200" 
                        onclick="setFilter('all')">
                    All<span class="ml-2 px-2 py-1 text-xs ${activeFilter === 'all' ? 'bg-white bg-opacity-30' : 'bg-black dark:bg-white bg-opacity-20 dark:bg-opacity-20'} rounded-full">${totalCount}</span>
                </button>
            `;
            decks.forEach((deck, index) => {
                if (deckCounts[index] > 0) {
                    const isActive = activeFilter === index.toString();
                    const activeClasses = isActive ? `${deck.activePillColor} text-white ${deck.activePillHover}` : 'bg-gray-50 dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600';
                    pillsHTML += `
                        <button class="text-sm border border-gray-300 dark:border-gray-600 ${activeClasses} px-2 pl-4 py-2 rounded-full transition-colors duration-200" 
                                onclick="setFilter('${index}')">
                            ${deck.title}<span class="ml-2 px-2 py-1 text-xs ${isActive ? 'bg-white bg-opacity-30' : 'bg-black dark:bg-white bg-opacity-20 dark:bg-opacity-20'} rounded-full">${deckCounts[index]}</span>
                        </button>
                    `;
                }
            });
            container.innerHTML = pillsHTML;
        }
        // Set active filter
        function setFilter(filter) {
            activeFilter = filter;
            updateFilterPills();
            updatePinnedCardsDisplay();
            saveData();
        }
        // Update pinned cards display
        function updatePinnedCardsDisplay() {
            const container = document.getElementById('pinnedCards');
            if (pinnedCards.length === 0) {
                container.innerHTML = '<div class="flex items-center justify-center h-48 text-gray-500 dark:text-gray-400 text-center min-w-full">No cards pinned yet. Pin some cards to see them here!</div>';
                return;
            }
            const filteredCards = activeFilter === 'all' 
                ? pinnedCards 
                : pinnedCards.filter(card => card.deckIndex.toString() === activeFilter);
            if (filteredCards.length === 0) {
                container.innerHTML = '<div class="flex items-center justify-center h-48 text-gray-500 dark:text-gray-400 text-center min-w-full">No cards match the selected filter.</div>';
                return;
            }
            const cardsHTML = filteredCards.map(card => `
                <div class="first:ml-4 w-[250px] h-fit bg-blue-50 dark:bg-blue-900/30 shadow-lg shadow-gray-400 dark:shadow-gray-600 rounded-lg flex-shrink-0 transition-all duration-200 cursor-pointer"
                     onclick="togglePin('${card.id}', ${card.deckIndex}, ${card.cardIndex})">
                    <div class="w-full rounded-lg bg-gray-100 dark:bg-gray-700 border-black border-4 flex items-center justify-center text-gray-600 dark:text-gray-400 overflow-hidden relative" 
                         style="aspect-ratio: 10/16;">
                        <img src="${card.imagePath}" alt="${card.displayName}" 
                             class="w-full h-full object-cover"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="w-full h-full flex items-center justify-center text-gray-400 dark:text-gray-500 text-sm" style="display: none;">
                            ${card.displayName}
                        </div>
                        <button class="absolute top-3 right-3 w-8 h-8 rounded-full text-white bg-red-600 hover:bg-red-700 text-sm flex items-center justify-center z-10 transition-colors duration-200" 
                                onclick="event.stopPropagation(); togglePin('${card.id}', ${card.deckIndex}, ${card.cardIndex})">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            `).join('');
            container.innerHTML = cardsHTML;
        }
        // Update pinned count
        function updatePinnedCount() {
            document.getElementById('pinnedCount').textContent = pinnedCards.length;
        }
        // Toggle drawer
        function toggleDrawer() {
            const drawer = document.getElementById('drawer');
            const button = drawer.querySelector('button i');
            const isOpen = drawer.style.transform === 'translateY(0px)';
            drawer.style.transform = isOpen ? 'translateY(calc(100% - 48px))' : 'translateY(0px)';
            button.className = isOpen ? 'fas fa-chevron-up' : 'fas fa-chevron-down';
        }
        // Open info modal
        function openInfoModal() {
            document.getElementById('infoModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
        }
        // Close info modal
        function closeInfoModal() {
            document.getElementById('infoModal').classList.add('hidden');
            document.body.style.overflow = 'auto'; // Restore scrolling
        }
        // Close modal on Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeInfoModal();
            }
        });
        // Listen for system dark mode changes
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
            // Only auto-update if user hasn't manually set a preference
            if (!localStorage.getItem('darkMode')) {
                darkMode = e.matches;
                applyDarkMode();
            }
        });
        // Initialize
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>